---
# https://github.com/wpacket/pan-ansible/blob/master/pan_config_pull.yml
- name: Backup Config from Palo Alto Firewall
  hosts: localhost
  gather_facts: no
  vars:
    # Palo Alto Firewall
    firewall_host: "{{ lookup('ansible.builtin.env', 'FIREWALL_HOST') }}"
    firewall_username: "{{ lookup('ansible.builtin.env', 'FIREWALL_USERNAME') }}"
    firewall_password: "{{ lookup('ansible.builtin.env', 'FIREWALL_PASSWORD') }}"
    # SFTP Server
    sftp_host: "{{ lookup('ansible.builtin.env', 'SFTP_HOST') }}"
    sftp_port: "{{ lookup('ansible.builtin.env', 'SFTP_PORT', default=22) }}"
    sftp_username: "{{ lookup('ansible.builtin.env', 'SFTP_USERNAME') }}"
    sftp_password: "{{ lookup('ansible.builtin.env', 'SFTP_PASSWORD') }}"
    sftp_path: "{{ lookup('ansible.builtin.env', 'SFTP_PATH') }}"
    # Pushover
    pushover_user: "{{ lookup('ansible.builtin.env', 'PUSHOVER_USER_KEY') }}"
    pushover_token: "{{ lookup('ansible.builtin.env', 'PUSHOVER_APP_TOKEN') }}"
  tasks:
    - name: Perform Backup
      block:
        - name: Create Config File Path
          ansible.builtin.set_fact:
            backup_config_file: "{{ firewall_host }}-config__{{ now().strftime('%Y.%m.%d') }}.xml"

        - name: Create .downloads/ Directory
          delegate_to: localhost
          ansible.builtin.file:
            path: .downloads/
            state: directory
            mode: '0755'

        - name: Generate API Key
          delegate_to: localhost
          ansible.builtin.uri:
            url: "https://{{ firewall_host }}/api/?type=keygen&user={{ firewall_username }}&password={{ firewall_password }}"
            method: GET
            validate_certs: no
            return_content: yes
          register: api_key_data

        - name: Extract API Key from XML Output
          delegate_to: localhost
          ansible.builtin.xml:
            xmlstring: "{{ api_key_data.content }}"
            content: "text"
            xpath: "/response/result/key"
          register: api_keys

        - name: Download Config File
          delegate_to: localhost
          ansible.builtin.get_url:
            url: "https://{{ firewall_host }}/api/?type=config&action=show&key={{ api_keys.matches[0].key }}"
            dest: ".downloads/{{ backup_config_file }}"
            validate_certs: no
            mode: 0644

        - name: Upload Config to SFTP
          delegate_to: localhost
          ansible.builtin.shell: "echo 'put .downloads/{{ backup_config_file }}' | sshpass -p '{{ sftp_password }}' sftp  -o StrictHostKeyChecking=no -P {{ sftp_port }} {{ sftp_username }}@{{ sftp_host }}:{{ sftp_path }}"

        - name: Delete Config File Locally
          delegate_to: localhost
          ansible.builtin.file:
            path: "./downloads/{{ backup_config_file }}"
            state: absent

      rescue:
        - name: Notify Admin of Failed Backup
          delegate_to: localhost
          ansible.builtin.uri:
            url: https://api.pushover.net/1/messages.json
            method: POST
            headers: 
              Content-Type: application/json
            body_format: json
            body:
              user: "{{ pushover_user }}"
              token: "{{ pushover_token }}"
              message: "‚ùå Unable to perform config backup for {{ firewall_host }}!"
